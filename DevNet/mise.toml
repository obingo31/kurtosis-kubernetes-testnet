# Project-scoped mise configuration for kurtosis-kubernetes-testnet
# Docs: https://mise.jdx.dev/configuration.html
min_version = { hard = "2024.11.1", soft = "2024.9.0" }

[env]
KIND_CLUSTER_NAME = "kurtosis-testnet"
KUBECONFIG = "{{config_root}}/.kube/kurtosis-testnet"
KURTOSIS_PACKAGE = "github.com/kurtosis-tech/eth2-package"

[settings]
experimental = true
idiomatic_version_file_enable_tools = ["go", "node", "python"]
task_output = "prefix"

[plugins]
kurtosis = "https://github.com/ethereum-optimism/asdf-kurtosis.git"

[tools]
go = "1.25.5"
node = { version = "lts", postinstall = "corepack enable" }
python = "3.13.1"
kubectl = "1.34.3"
helm = "4.0.1"
kind = "0.30.0"
terraform = "1.14.1"
kurtosis = "1.13.2"

[tasks.bootstrap]
description = "Install every pinned tool and prove the CLIs are reachable"
run = '''
set -euo pipefail
mise install
mise ls --current
kubectl version --client --output=yaml
helm version --short
terraform version
'''

[tasks.cluster-up]
depends = ["bootstrap"]
description = "Create (or reuse) a local kind cluster for testnet work"
run = '''
set -euo pipefail
if kind get clusters | grep -qx "$KIND_CLUSTER_NAME"; then
  echo "kind cluster '$KIND_CLUSTER_NAME' already exists"
else
  kind create cluster --name "$KIND_CLUSTER_NAME" --wait 120s
fi
kubectl config use-context "kind-$KIND_CLUSTER_NAME"
kubectl cluster-info
'''

[tasks.cluster-down]
description = "Tear down the local kind cluster"
run = '''
set -euo pipefail
if kind get clusters | grep -qx "$KIND_CLUSTER_NAME"; then
  kind delete cluster --name "$KIND_CLUSTER_NAME"
else
  echo "No cluster named '$KIND_CLUSTER_NAME' found"
fi
'''

[tasks.kurtosis-check]
description = "Ensures Kurtosis CLI is available before running packages"
run = '''
set -euo pipefail
kurtosis version
kurtosis engine status || true
'''
